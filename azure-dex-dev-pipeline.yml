# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript


pool:
  name: Azure Pipeline

variables:
  VM_HOST: $(DEX_VM_HOST)          # Update with your VM's host
  VM_USER: $(DEX_VM_USER)      # Update with your VM's username
  SSH_PRIVATE_KEY: $(SSH_PRIVATE_KEY) # Define this as a secret variable in the pipeline settings
  PROJECT_PATH: $(PROJECT_RELATIVE_PATH) # Relative path to project directory

steps:
- script: |
    echo "$SSH_PRIVATE_KEY" > id_rsa
    chmod 600 id_rsa
    ssh -o StrictHostKeyChecking=no -i id_rsa $(VM_USER)@$(VM_HOST) << 'EOF'
    cd /home/$(VM_USER)/$(PROJECT_PATH) # Update with the correct path on your VM
    git pull origin main # Pull the latest changes from the repo
    docker-compose up -d --build
    EOF
    rm id_rsa
  displayName: 'Deploy Changes and Updating Composer'
